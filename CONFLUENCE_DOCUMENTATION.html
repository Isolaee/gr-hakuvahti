<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACF Field Analyzer (Hakuvahti) - Technical Documentation</title>
    <style>
        :root {
            --primary-color: #0052cc;
            --secondary-color: #172b4d;
            --accent-color: #00875a;
            --warning-color: #ff991f;
            --danger-color: #de350b;
            --background-color: #f4f5f7;
            --card-background: #ffffff;
            --border-color: #dfe1e6;
            --code-background: #f4f5f7;
            --text-color: #172b4d;
            --text-muted: #6b778c;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #0052cc 0%, #172b4d 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0 0 10px;
            font-size: 2.5rem;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .header .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 15px;
        }

        /* Navigation */
        .toc {
            background: var(--card-background);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .toc h2 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 1.2rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .toc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .toc-section {
            background: var(--background-color);
            padding: 15px;
            border-radius: 6px;
        }

        .toc-section h3 {
            margin: 0 0 10px;
            font-size: 0.95rem;
            color: var(--primary-color);
        }

        .toc-section ul {
            margin: 0;
            padding-left: 20px;
        }

        .toc-section li {
            margin: 5px 0;
        }

        .toc-section a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .toc-section a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .card h3 {
            color: var(--secondary-color);
            font-size: 1.2rem;
            margin-top: 25px;
        }

        .card h4 {
            color: var(--text-muted);
            font-size: 1rem;
            margin-top: 20px;
        }

        /* Code blocks */
        pre {
            background: var(--code-background);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            overflow-x: auto;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        code {
            background: var(--code-background);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.85em;
        }

        pre code {
            background: none;
            padding: 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--background-color);
            font-weight: 600;
            color: var(--secondary-color);
        }

        tr:hover {
            background: var(--background-color);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-primary { background: #deebff; color: #0052cc; }
        .badge-success { background: #e3fcef; color: #00875a; }
        .badge-warning { background: #fffae6; color: #ff991f; }
        .badge-danger { background: #ffebe6; color: #de350b; }
        .badge-info { background: #e6fcff; color: #00b8d9; }

        /* Info boxes */
        .info-box {
            padding: 15px 20px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .info-box.note {
            background: #e6fcff;
            border-color: #00b8d9;
        }

        .info-box.warning {
            background: #fffae6;
            border-color: #ff991f;
        }

        .info-box.success {
            background: #e3fcef;
            border-color: #00875a;
        }

        .info-box.danger {
            background: #ffebe6;
            border-color: #de350b;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        /* File tree */
        .file-tree {
            font-family: 'SFMono-Regular', Consolas, monospace;
            font-size: 0.85rem;
            background: var(--code-background);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .file-tree ul {
            list-style: none;
            padding-left: 20px;
            margin: 0;
        }

        .file-tree > ul {
            padding-left: 0;
        }

        .file-tree li {
            position: relative;
            padding: 3px 0;
        }

        .file-tree .folder {
            color: var(--primary-color);
            font-weight: 600;
        }

        .file-tree .file {
            color: var(--text-color);
        }

        .file-tree .comment {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Flowchart/Diagram */
        .diagram {
            background: var(--code-background);
            padding: 20px;
            border-radius: 6px;
            text-align: center;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }

        /* Grid layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        /* Feature list */
        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
            border-bottom: 1px solid var(--border-color);
        }

        .feature-list li:before {
            content: "OK";
            position: absolute;
            left: 0;
            color: var(--accent-color);
            font-weight: bold;
            font-size: 0.7em;
        }

        /* API endpoint styling */
        .endpoint {
            background: var(--code-background);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin: 15px 0;
            overflow: hidden;
        }

        .endpoint-header {
            padding: 12px 15px;
            background: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .endpoint-method {
            background: var(--accent-color);
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .endpoint-path {
            font-family: monospace;
        }

        .endpoint-body {
            padding: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .toc-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Print styles */
        @media print {
            .header {
                background: var(--secondary-color);
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .card {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="container">
        <h1>ACF Field Analyzer (Hakuvahti)</h1>
        <p class="subtitle">WordPress Plugin - Technical Documentation</p>
        <span class="version-badge">Version 1.0.0 | PHP 7.4+ | WordPress 5.8+</span>
    </div>
</div>

<div class="container">

    <!-- Table of Contents -->
    <nav class="toc">
        <h2>Table of Contents</h2>
        <div class="toc-grid">
            <div class="toc-section">
                <h3>Overview</h3>
                <ul>
                    <li><a href="#overview">Project Overview</a></li>
                    <li><a href="#features">Features</a></li>
                    <li><a href="#requirements">Requirements</a></li>
                </ul>
            </div>
            <div class="toc-section">
                <h3>Architecture</h3>
                <ul>
                    <li><a href="#file-structure">File Structure</a></li>
                    <li><a href="#classes">Core Classes</a></li>
                    <li><a href="#data-flow">Data Flow</a></li>
                </ul>
            </div>
            <div class="toc-section">
                <h3>Database</h3>
                <ul>
                    <li><a href="#database-schema">Database Schema</a></li>
                    <li><a href="#wp-options">WordPress Options</a></li>
                    <li><a href="#transients">Transients</a></li>
                </ul>
            </div>
            <div class="toc-section">
                <h3>API Reference</h3>
                <ul>
                    <li><a href="#ajax-endpoints">AJAX Endpoints</a></li>
                    <li><a href="#php-api">PHP API</a></li>
                    <li><a href="#javascript-api">JavaScript API</a></li>
                </ul>
            </div>
            <div class="toc-section">
                <h3>Frontend</h3>
                <ul>
                    <li><a href="#shortcodes">Shortcodes</a></li>
                    <li><a href="#javascript-modules">JavaScript Modules</a></li>
                    <li><a href="#css-styles">CSS Styles</a></li>
                </ul>
            </div>
            <div class="toc-section">
                <h3>Development</h3>
                <ul>
                    <li><a href="#testing">Testing</a></li>
                    <li><a href="#security">Security</a></li>
                    <li><a href="#deployment">Deployment</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Overview Section -->
    <section id="overview" class="card">
        <h2>Project Overview</h2>
        <p>
            <strong>ACF Field Analyzer</strong> (Finnish: <em>Hakuvahti</em> - "search watch") is a WordPress plugin
            that enables users to search posts by Advanced Custom Fields (ACF) criteria and create saved search
            "watches" that automatically notify users when new matching posts are published.
        </p>

        <div class="grid-3">
            <div>
                <h4>Plugin Details</h4>
                <table>
                    <tr><td><strong>Text Domain</strong></td><td><code>acf-analyzer</code></td></tr>
                    <tr><td><strong>Primary Language</strong></td><td>Finnish</td></tr>
                    <tr><td><strong>License</strong></td><td>GPL-2.0-or-later</td></tr>
                </table>
            </div>
            <div>
                <h4>Supported Categories</h4>
                <ul>
                    <li><strong>Osakeannit</strong> - Share offerings</li>
                    <li><strong>Osaketori</strong> - Stock market</li>
                    <li><strong>Velkakirjat</strong> - Debt instruments</li>
                </ul>
            </div>
            <div>
                <h4>Key Integrations</h4>
                <ul>
                    <li>Advanced Custom Fields (ACF)</li>
                    <li>WP Grid Builder</li>
                    <li>WooCommerce</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="card">
        <h2>Features</h2>

        <div class="grid-2">
            <div>
                <h3>Core Search Capabilities</h3>
                <ul class="feature-list">
                    <li><strong>ACF Field Search</strong> - Multiple criteria with AND/OR logic</li>
                    <li><strong>Range Comparisons</strong> - Numeric min/max field searches</li>
                    <li><strong>Nested Field Support</strong> - Dot notation access (parent.child)</li>
                    <li><strong>Value Normalization</strong> - Finnish/Swedish diacritic handling</li>
                    <li><strong>Batch Processing</strong> - Memory-efficient queries (200 posts/batch)</li>
                </ul>
            </div>
            <div>
                <h3>Saved Searches (Hakuvahdits)</h3>
                <ul class="feature-list">
                    <li><strong>Save Criteria</strong> - Store search configurations</li>
                    <li><strong>New Post Detection</strong> - Track seen vs. new posts</li>
                    <li><strong>Email Notifications</strong> - HTML-formatted alerts</li>
                    <li><strong>Daily Runner</strong> - Scheduled WP-Cron execution</li>
                    <li><strong>Deduplication</strong> - SHA1 hash prevents duplicate notifications</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Requirements Section -->
    <section id="requirements" class="card">
        <h2>Requirements</h2>

        <table>
            <thead>
                <tr>
                    <th>Requirement</th>
                    <th>Version</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>WordPress</td>
                    <td>5.8+</td>
                    <td><span class="badge badge-danger">Required</span></td>
                </tr>
                <tr>
                    <td>PHP</td>
                    <td>7.4+</td>
                    <td><span class="badge badge-danger">Required</span></td>
                </tr>
                <tr>
                    <td>Advanced Custom Fields (ACF)</td>
                    <td>Latest</td>
                    <td><span class="badge badge-danger">Required</span></td>
                </tr>
                <tr>
                    <td>WooCommerce</td>
                    <td>Latest</td>
                    <td><span class="badge badge-info">Optional</span></td>
                </tr>
                <tr>
                    <td>WP Grid Builder</td>
                    <td>Latest</td>
                    <td><span class="badge badge-info">Optional</span></td>
                </tr>
            </tbody>
        </table>

        <div class="info-box note">
            <strong>Note</strong>
            WooCommerce is required for the My Account page integration. WP Grid Builder is required for facet-based filtering on the frontend.
        </div>
    </section>

    <!-- File Structure Section -->
    <section id="file-structure" class="card">
        <h2>File Structure</h2>

        <div class="file-tree">
            <ul>
                <li><span class="folder">hakuvahti/</span>
                    <ul>
                        <li><span class="file">acf-analyzer.php</span> <span class="comment">// Main plugin bootstrap (193 lines)</span></li>
                        <li><span class="file">uninstall.php</span> <span class="comment">// Cleanup on uninstall</span></li>
                        <li><span class="folder">includes/</span>
                            <ul>
                                <li><span class="file">class-acf-analyzer.php</span> <span class="comment">// Core search engine (439 lines)</span></li>
                                <li><span class="file">class-acf-analyzer-admin.php</span> <span class="comment">// Admin interface (395 lines)</span></li>
                                <li><span class="file">class-acf-analyzer-shortcode.php</span> <span class="comment">// Frontend shortcodes (650 lines)</span></li>
                                <li><span class="file">class-hakuvahti.php</span> <span class="comment">// Saved searches model (808 lines)</span></li>
                                <li><span class="file">class-hakuvahti-woocommerce.php</span> <span class="comment">// WooCommerce integration (153 lines)</span></li>
                            </ul>
                        </li>
                        <li><span class="folder">templates/</span>
                            <ul>
                                <li><span class="file">admin-page.php</span> <span class="comment">// Admin dashboard</span></li>
                                <li><span class="file">hakuvahti-page.php</span> <span class="comment">// WooCommerce account page</span></li>
                                <li><span class="file">logger-button.php</span> <span class="comment">// Shortcode button output</span></li>
                            </ul>
                        </li>
                        <li><span class="folder">assets/</span>
                            <ul>
                                <li><span class="folder">js/</span>
                                    <ul>
                                        <li><span class="file">wpgb-facet-logger.js</span> <span class="comment">// Frontend search builder (364 lines)</span></li>
                                        <li><span class="file">hakuvahti-page.js</span> <span class="comment">// My Account page (383 lines)</span></li>
                                        <li><span class="file">admin-mapping.js</span> <span class="comment">// Admin editor (273 lines)</span></li>
                                    </ul>
                                </li>
                                <li><span class="folder">css/</span>
                                    <ul>
                                        <li><span class="file">admin.css</span> <span class="comment">// Admin styling (312 lines)</span></li>
                                        <li><span class="file">hakuvahti.css</span> <span class="comment">// Frontend styling (392 lines)</span></li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li><span class="folder">tests/</span>
                            <ul>
                                <li><span class="folder">js/</span>
                                    <ul>
                                        <li><span class="file">setup.js</span> <span class="comment">// Jest configuration and mocks</span></li>
                                        <li><span class="folder">unit/</span>
                                            <ul>
                                                <li><span class="file">facetLogger.test.js</span> <span class="comment">// 45 tests</span></li>
                                                <li><span class="file">hakuvahtiPage.test.js</span> <span class="comment">// 62 tests</span></li>
                                                <li><span class="file">adminMapping.test.js</span> <span class="comment">// 47 tests</span></li>
                                            </ul>
                                        </li>
                                        <li><span class="folder">integration/</span>
                                            <ul>
                                                <li><span class="file">ajaxOperations.test.js</span> <span class="comment">// 55 tests</span></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </section>

    <!-- Core Classes Section -->
    <section id="classes" class="card">
        <h2>Core Classes</h2>

        <h3>ACF_Analyzer</h3>
        <p>Core search engine with batch processing and field matching.</p>
        <table>
            <thead>
                <tr><th>Method</th><th>Description</th><th>Returns</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>search_by_criteria($criteria, $options)</code></td>
                    <td>Search posts by ACF field criteria with AND/OR logic</td>
                    <td><code>array</code> - Posts with metadata</td>
                </tr>
                <tr>
                    <td><code>get_all_field_names($categories)</code></td>
                    <td>Discover all unique ACF field names from posts</td>
                    <td><code>array</code> - Sorted field names</td>
                </tr>
                <tr>
                    <td><code>get_nested_field_value($fields, $name)</code></td>
                    <td>Get field value using dot notation (e.g., parent.child)</td>
                    <td><code>mixed</code> - Field value or null</td>
                </tr>
                <tr>
                    <td><code>normalize_to_slug($value)</code></td>
                    <td>Normalize string for comparison (handles diacritics)</td>
                    <td><code>string</code> - Normalized slug</td>
                </tr>
            </tbody>
        </table>

        <h3>Hakuvahti</h3>
        <p>Saved searches CRUD, daily runner, and email notifications.</p>
        <table>
            <thead>
                <tr><th>Method</th><th>Description</th><th>Returns</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>create($user_id, $name, $category, $criteria)</code></td>
                    <td>Create a new saved search with initial seen posts</td>
                    <td><code>int|false</code> - Insert ID</td>
                </tr>
                <tr>
                    <td><code>get_by_user($user_id)</code></td>
                    <td>Get all saved searches for a user</td>
                    <td><code>array</code> - Hakuvahti objects</td>
                </tr>
                <tr>
                    <td><code>run_search($id, $user_id)</code></td>
                    <td>Execute search and return only NEW results</td>
                    <td><code>array|false</code> - Results</td>
                </tr>
                <tr>
                    <td><code>run_daily_searches()</code></td>
                    <td>Scheduled task: run all searches, send emails</td>
                    <td><code>void</code></td>
                </tr>
                <tr>
                    <td><code>delete($id, $user_id)</code></td>
                    <td>Delete a saved search (ownership verified)</td>
                    <td><code>bool</code></td>
                </tr>
            </tbody>
        </table>

        <h3>ACF_Analyzer_Shortcode</h3>
        <p>Frontend shortcodes and public AJAX endpoints.</p>
        <table>
            <thead>
                <tr><th>Method</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>render_hakuvahti($atts)</code></td>
                    <td>Render the [acf_hakuvahti] shortcode button and modal</td>
                </tr>
                <tr>
                    <td><code>ajax_search_handler()</code></td>
                    <td>Public AJAX endpoint for searching posts</td>
                </tr>
                <tr>
                    <td><code>ajax_hakuvahti_save()</code></td>
                    <td>Authenticated AJAX endpoint to save searches</td>
                </tr>
            </tbody>
        </table>

        <h3>Hakuvahti_WooCommerce</h3>
        <p>WooCommerce My Account endpoint integration.</p>
        <table>
            <thead>
                <tr><th>Method</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>add_hakuvahti_endpoint()</code></td>
                    <td>Register /hakuvahdit/ endpoint in WooCommerce</td>
                </tr>
                <tr>
                    <td><code>hakuvahti_content()</code></td>
                    <td>Render the My Account hakuvahti page content</td>
                </tr>
            </tbody>
        </table>
    </section>

    <!-- Data Flow Section -->
    <section id="data-flow" class="card">
        <h2>Data Flow</h2>

        <h3>Search Algorithm Flow</h3>
        <div class="diagram">
+------------------+
|  User Criteria   |
|  (Frontend)      |
+--------+---------+
         |
         v
+----------------------------------------------------------+
|  ACF_Analyzer::search_by_criteria()                      |
+----------------------------------------------------------+
|  1. Query posts in batches of 200                        |
|  2. get_fields($post_id) for each post                   |
|  3. For each criterion:                                  |
|     - Range: field_min/field_max with &gt;=/&lt;= operators   |
|     - Array OR: match if any value equals actual         |
|     - Scalar: exact normalized match                     |
|  4. Apply match logic (AND requires all, OR any)         |
|  5. Return matched posts with metadata                   |
+----------------------------------------------------------+
         |
         v
+------------------+
|  Search Results  |
|  (JSON)          |
+------------------+
        </div>

        <h3>Daily Runner Flow</h3>
        <div class="diagram">
+--------------------+     +--------------------+
|  WP-Cron           | OR  |  External Cron     |
|  (wp_schedule)     |     |  (HTTP ping)       |
+---------+----------+     +---------+----------+
          |                          |
          +------------+-------------+
                       v
+----------------------------------------------------------+
|  Hakuvahti::run_daily_searches()                         |
+----------------------------------------------------------+
|  1. Load all hakuvahdit from database                    |
|  2. For each hakuvahti:                                  |
|     - run_search() -&gt; get NEW posts only                 |
|     - Insert matches (deduplicated by hash)              |
|     - Queue for email notification                       |
|  3. Group results by user                                |
|  4. Send HTML emails via wp_mail()                       |
|  5. Update acf_analyzer_last_run option                  |
+----------------------------------------------------------+
        </div>

        <h3>Deduplication Strategy</h3>
        <div class="info-box success">
            <strong>Hash Formula</strong>
            <code>sha1($post_id . '|' . $hakuvahti_id)</code>
            <p style="margin: 10px 0 0;">MySQL UNIQUE constraint on <code>(search_id, match_hash)</code> prevents duplicate notifications for the same post/search combination.</p>
        </div>
    </section>

    <!-- Database Schema Section -->
    <section id="database-schema" class="card">
        <h2>Database Schema</h2>

        <h3>Table: wp_hakuvahdit</h3>
        <p>Stores saved search configurations.</p>
        <pre><code>CREATE TABLE wp_hakuvahdit (
    id BIGINT(20) UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT(20) UNSIGNED NOT NULL,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(100) NOT NULL,
    criteria LONGTEXT NOT NULL,         -- JSON-encoded search criteria
    seen_post_ids LONGTEXT,             -- JSON-encoded array of seen post IDs
    created_at DATETIME NOT NULL,
    updated_at DATETIME,
    KEY user_id (user_id)
);</code></pre>

        <h4>Criteria JSON Structure</h4>
        <pre><code>[
    {
        "name": "hinta",           // ACF field name
        "label": "range",          // Type: "range" or "multiple_choice"
        "values": ["100", "500"]   // For range: [min, max] or ["min:100"] or ["max:500"]
    },
    {
        "name": "sijainti",
        "label": "multiple_choice",
        "values": ["helsinki", "espoo", "tampere"]
    }
]</code></pre>

        <h3>Table: wp_hakuvahti_matches</h3>
        <p>Stores deduplicated match results from daily runs.</p>
        <pre><code>CREATE TABLE wp_hakuvahti_matches (
    id BIGINT(20) UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    search_id BIGINT(20) UNSIGNED NOT NULL,
    match_id BIGINT(20) UNSIGNED NOT NULL,
    match_hash VARCHAR(64) NOT NULL,
    meta LONGTEXT,                       -- JSON post data
    created_at DATETIME NOT NULL,
    UNIQUE KEY search_match (search_id, match_hash),
    KEY search_id (search_id),
    KEY match_id (match_id)
);</code></pre>
    </section>

    <!-- WordPress Options Section -->
    <section id="wp-options" class="card">
        <h2>WordPress Options</h2>

        <table>
            <thead>
                <tr>
                    <th>Option Key</th>
                    <th>Type</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>acf_wpgb_facet_map</code></td>
                    <td>array</td>
                    <td>WPGB facet slug to ACF field name mappings</td>
                </tr>
                <tr>
                    <td><code>acf_analyzer_user_search_options</code></td>
                    <td>array</td>
                    <td>Admin-configured user search options per category</td>
                </tr>
                <tr>
                    <td><code>acf_analyzer_last_run</code></td>
                    <td>string</td>
                    <td>Timestamp of last daily runner execution</td>
                </tr>
                <tr>
                    <td><code>acf_analyzer_last_run_debug</code></td>
                    <td>array</td>
                    <td>Debug log from last daily run</td>
                </tr>
                <tr>
                    <td><code>acf_analyzer_secret_key</code></td>
                    <td>string</td>
                    <td>32-character secret for true-cron authentication</td>
                </tr>
                <tr>
                    <td><code>acf_analyzer_ignore_seen</code></td>
                    <td>bool</td>
                    <td>Flag for showing all vs. new posts only (testing)</td>
                </tr>
            </tbody>
        </table>
    </section>

    <!-- Transients Section -->
    <section id="transients" class="card">
        <h2>Transients (Caching)</h2>

        <table>
            <thead>
                <tr>
                    <th>Transient Key</th>
                    <th>TTL</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>acf_analyzer_field_names</code></td>
                    <td>1 hour</td>
                    <td>Cached list of discovered ACF field names</td>
                </tr>
                <tr>
                    <td><code>acf_analyzer_search_results</code></td>
                    <td>1 hour</td>
                    <td>Cached search results (admin panel)</td>
                </tr>
            </tbody>
        </table>

        <div class="info-box note">
            <strong>Cache Invalidation</strong>
            Use the "Refresh Fields" button in the admin panel to clear the field names cache manually.
        </div>
    </section>

    <!-- AJAX Endpoints Section -->
    <section id="ajax-endpoints" class="card">
        <h2>AJAX Endpoints</h2>

        <h3>Public Endpoints <span class="badge badge-success">No Auth Required</span></h3>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=acf_popup_search</span>
            </div>
            <div class="endpoint-body">
                <p>Search posts by ACF field criteria.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>CSRF nonce token</td></tr>
                    <tr><td><code>category</code></td><td>string</td><td>Category to search (Osakeannit, etc.)</td></tr>
                    <tr><td><code>criteria</code></td><td>array</td><td>Search criteria array</td></tr>
                    <tr><td><code>match_logic</code></td><td>string</td><td>"AND" or "OR" (default: AND)</td></tr>
                </table>
            </div>
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=acf_popup_get_fields</span>
            </div>
            <div class="endpoint-body">
                <p>Get available ACF fields for a category.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>CSRF nonce token</td></tr>
                    <tr><td><code>category</code></td><td>string</td><td>Category to fetch fields for</td></tr>
                </table>
            </div>
        </div>

        <h3>Authenticated Endpoints <span class="badge badge-warning">Login Required</span></h3>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=hakuvahti_save</span>
            </div>
            <div class="endpoint-body">
                <p>Create or update a saved search.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>CSRF nonce token</td></tr>
                    <tr><td><code>id</code></td><td>int</td><td>(Optional) Hakuvahti ID for update</td></tr>
                    <tr><td><code>name</code></td><td>string</td><td>User-defined name</td></tr>
                    <tr><td><code>category</code></td><td>string</td><td>Category</td></tr>
                    <tr><td><code>criteria</code></td><td>array|string</td><td>Search criteria (array or JSON string)</td></tr>
                </table>
            </div>
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=hakuvahti_run</span>
            </div>
            <div class="endpoint-body">
                <p>Execute a saved search and return new results.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>CSRF nonce token</td></tr>
                    <tr><td><code>id</code></td><td>int</td><td>Hakuvahti ID</td></tr>
                </table>
                <h4>Response</h4>
                <pre><code>{
    "success": true,
    "data": {
        "posts": [
            {"ID": 123, "title": "Post Title", "url": "/post-url/"}
        ],
        "total_found": 1,
        "total_all": 5
    }
}</code></pre>
            </div>
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=hakuvahti_delete</span>
            </div>
            <div class="endpoint-body">
                <p>Delete a saved search.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>CSRF nonce token</td></tr>
                    <tr><td><code>id</code></td><td>int</td><td>Hakuvahti ID</td></tr>
                </table>
            </div>
        </div>

        <h3>Admin Endpoints <span class="badge badge-danger">manage_options Required</span></h3>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=acf_analyzer_save_user_options</span>
            </div>
            <div class="endpoint-body">
                <p>Save admin-configured user search options.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>Admin nonce token</td></tr>
                    <tr><td><code>options</code></td><td>array</td><td>User search options array</td></tr>
                    <tr><td><code>options_json</code></td><td>string</td><td>JSON-encoded options (backup)</td></tr>
                </table>
            </div>
        </div>

        <div class="endpoint">
            <div class="endpoint-header">
                <span class="endpoint-method">POST</span>
                <span class="endpoint-path">wp-admin/admin-ajax.php?action=acf_analyzer_get_fields_by_category</span>
            </div>
            <div class="endpoint-body">
                <p>Get ACF fields with metadata for admin editor.</p>
                <h4>Parameters</h4>
                <table>
                    <tr><td><code>nonce</code></td><td>string</td><td>Admin nonce token</td></tr>
                    <tr><td><code>category</code></td><td>string</td><td>Category to fetch fields for</td></tr>
                </table>
                <h4>Response</h4>
                <pre><code>{
    "success": true,
    "data": [
        {"key": "hinta", "label": "Hinta", "has_choices": false},
        {"key": "tyyppi", "label": "Tyyppi", "has_choices": true, "choices": {"a": "A", "b": "B"}}
    ]
}</code></pre>
            </div>
        </div>
    </section>

    <!-- Shortcodes Section -->
    <section id="shortcodes" class="card">
        <h2>Shortcodes</h2>

        <h3>[acf_hakuvahti]</h3>
        <p>Renders the "Save hakuvahti" button and modal for creating saved searches.</p>

        <h4>Attributes</h4>
        <table>
            <thead>
                <tr><th>Attribute</th><th>Default</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>category</code></td>
                    <td>(auto-detected)</td>
                    <td>Category slug (osakeannit, velkakirjat, osaketori)</td>
                </tr>
                <tr>
                    <td><code>button_text</code></td>
                    <td>"Tallenna hakuvahti"</td>
                    <td>Button label text</td>
                </tr>
            </tbody>
        </table>

        <h4>Example Usage</h4>
        <pre><code>&lt;!-- Auto-detect category from URL --&gt;
[acf_hakuvahti]

&lt;!-- Explicit category and custom button text --&gt;
[acf_hakuvahti category="osakeannit" button_text="Tallenna haku"]</code></pre>
    </section>

    <!-- JavaScript Modules Section -->
    <section id="javascript-modules" class="card">
        <h2>JavaScript Modules</h2>

        <h3>wpgb-facet-logger.js</h3>
        <p>Frontend search builder using admin-defined User Search Options.</p>

        <h4>Key Functions</h4>
        <table>
            <thead>
                <tr><th>Function</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>detectCategory()</code></td>
                    <td>Detect category from URL path or body classes</td>
                </tr>
                <tr>
                    <td><code>getOptionsForCategory(category)</code></td>
                    <td>Filter user search options for a category</td>
                </tr>
                <tr>
                    <td><code>buildSearchForm(category)</code></td>
                    <td>Build the search form from user options</td>
                </tr>
                <tr>
                    <td><code>buildFieldInput(opt)</code></td>
                    <td>Build input field based on option type (range/multiple_choice)</td>
                </tr>
                <tr>
                    <td><code>collectSearchCriteria()</code></td>
                    <td>Collect criteria from form inputs</td>
                </tr>
                <tr>
                    <td><code>openModal() / closeModal()</code></td>
                    <td>Modal visibility management</td>
                </tr>
            </tbody>
        </table>

        <h4>Global Configuration</h4>
        <pre><code>window.acfWpgbLogger = {
    ajaxUrl: '/wp-admin/admin-ajax.php',
    hakuvahtiNonce: 'nonce-token',
    myPageUrl: '/my-account/hakuvahdit/',
    userSearchOptions: [
        { name: 'Hinta', category: 'Osakeannit', acf_field: 'hinta', values: { min: '', max: '', postfix: 'EUR' } },
        { name: 'Tyyppi', category: 'Osakeannit', acf_field: 'tyyppi', values: ['A', 'B', 'C'] }
    ]
};</code></pre>

        <h3>hakuvahti-page.js</h3>
        <p>WooCommerce My Account page functionality.</p>

        <h4>Key Functions</h4>
        <table>
            <thead>
                <tr><th>Function</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>fetchFieldsForCategory(category, callback)</code></td>
                    <td>Fetch and cache available fields for a category</td>
                </tr>
                <tr>
                    <td><code>formatCriteriaHTML(crits)</code></td>
                    <td>Format criteria for display with range/operator handling</td>
                </tr>
                <tr>
                    <td><code>escapeHtml(s)</code></td>
                    <td>HTML-escape a string for safe output</td>
                </tr>
                <tr>
                    <td><code>buildFieldDropdown(fields, selectedValue)</code></td>
                    <td>Build field name dropdown HTML</td>
                </tr>
            </tbody>
        </table>

        <h4>Event Handlers</h4>
        <ul>
            <li><code>.hakuvahti-run-btn</code> - Run search and display results</li>
            <li><code>.hakuvahti-edit-btn</code> - Open inline edit form</li>
            <li><code>.hakuvahti-save-edit</code> - Save edited hakuvahti</li>
            <li><code>.hakuvahti-delete-btn</code> - Delete hakuvahti (with confirmation)</li>
            <li><code>.hakuvahti-add-criterion</code> - Add new criterion to edit form</li>
        </ul>

        <h3>admin-mapping.js</h3>
        <p>Admin User Search Options editor.</p>

        <h4>Key Functions</h4>
        <table>
            <thead>
                <tr><th>Function</th><th>Description</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>initSearchOptionsEditor()</code></td>
                    <td>Initialize the editor with saved options</td>
                </tr>
                <tr>
                    <td><code>renderSearchOptionsEditor()</code></td>
                    <td>Render the options list for current tab</td>
                </tr>
                <tr>
                    <td><code>renderSearchOptionRow(opt, index)</code></td>
                    <td>Render a single option row with all fields</td>
                </tr>
                <tr>
                    <td><code>renderValuesAreaFor($acfSelect, $container, opt)</code></td>
                    <td>Render values area based on field type (choices or range)</td>
                </tr>
                <tr>
                    <td><code>collectUserOptions()</code></td>
                    <td>Collect current options from form</td>
                </tr>
                <tr>
                    <td><code>saveUserOptions()</code></td>
                    <td>Save options via AJAX (validates acf_field required)</td>
                </tr>
            </tbody>
        </table>
    </section>

    <!-- Testing Section -->
    <section id="testing" class="card">
        <h2>Testing</h2>

        <div class="grid-2">
            <div>
                <h3>JavaScript Tests (Jest)</h3>
                <p>209 tests covering all JavaScript modules.</p>

                <h4>Run Commands</h4>
                <pre><code># Run all tests
npm test

# Run unit tests only
npm run test:unit

# Run integration tests only
npm run test:integration

# Watch mode
npm run test:watch

# With coverage
npm run test:coverage</code></pre>

                <h4>Test Files</h4>
                <table>
                    <tr><td><code>facetLogger.test.js</code></td><td>45 tests</td></tr>
                    <tr><td><code>hakuvahtiPage.test.js</code></td><td>62 tests</td></tr>
                    <tr><td><code>adminMapping.test.js</code></td><td>47 tests</td></tr>
                    <tr><td><code>ajaxOperations.test.js</code></td><td>55 tests</td></tr>
                </table>
            </div>
            <div>
                <h3>PHP Tests (Pest)</h3>
                <p>Pest PHP framework with Brain\Monkey for WordPress mocking.</p>

                <h4>Run Commands</h4>
                <pre><code># Install dependencies
composer install

# Run all tests
composer test

# Run unit tests only
composer test:unit

# Run integration tests
composer test:integration

# With coverage
composer test:coverage</code></pre>

                <h4>Dependencies</h4>
                <ul>
                    <li><code>pestphp/pest</code> - Testing framework</li>
                    <li><code>mockery/mockery</code> - Mocking library</li>
                    <li><code>brain/monkey</code> - WordPress function mocking</li>
                </ul>
            </div>
        </div>

        <h3>Test Coverage Areas</h3>
        <div class="grid-3">
            <div class="info-box success">
                <strong>Unit Tests</strong>
                <ul>
                    <li>Category detection</li>
                    <li>Criteria collection</li>
                    <li>HTML escaping</li>
                    <li>Range value parsing</li>
                    <li>Field type detection</li>
                    <li>Validation logic</li>
                </ul>
            </div>
            <div class="info-box note">
                <strong>Integration Tests</strong>
                <ul>
                    <li>AJAX request building</li>
                    <li>Response handling</li>
                    <li>Error handling</li>
                    <li>Button state management</li>
                    <li>Nonce handling</li>
                </ul>
            </div>
            <div class="info-box warning">
                <strong>Manual Testing</strong>
                <ul>
                    <li>End-to-end flows</li>
                    <li>Email delivery</li>
                    <li>WooCommerce integration</li>
                    <li>WPGB facet mapping</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Security Section -->
    <section id="security" class="card">
        <h2>Security</h2>

        <h3>Nonce Verification</h3>
        <table>
            <thead>
                <tr><th>Nonce Action</th><th>Usage</th></tr>
            </thead>
            <tbody>
                <tr><td><code>acf_analyzer_save_mapping</code></td><td>Admin mapping saves</td></tr>
                <tr><td><code>acf_analyzer_search</code></td><td>Admin search form</td></tr>
                <tr><td><code>acf_popup_search</code></td><td>Frontend search</td></tr>
                <tr><td><code>hakuvahti_nonce</code></td><td>Hakuvahti CRUD operations</td></tr>
            </tbody>
        </table>

        <h3>Access Control</h3>
        <div class="grid-3">
            <div class="info-box danger">
                <strong>Admin Functions</strong>
                <code>current_user_can('manage_options')</code>
            </div>
            <div class="info-box warning">
                <strong>User Operations</strong>
                Ownership verification via <code>user_id</code> match
            </div>
            <div class="info-box note">
                <strong>True-Cron</strong>
                <code>hash_equals()</code> constant-time comparison
            </div>
        </div>

        <h3>Data Sanitization</h3>
        <table>
            <thead>
                <tr><th>Input Type</th><th>Sanitization Method</th></tr>
            </thead>
            <tbody>
                <tr><td>Text fields</td><td><code>sanitize_text_field()</code></td></tr>
                <tr><td>JSON data</td><td><code>wp_json_encode() / json_decode()</code> with validation</td></tr>
                <tr><td>SQL queries</td><td><code>$wpdb-&gt;prepare()</code> with placeholders</td></tr>
                <tr><td>HTML output</td><td><code>esc_html(), esc_attr(), esc_url()</code></td></tr>
            </tbody>
        </table>
    </section>

    <!-- Deployment Section -->
    <section id="deployment" class="card">
        <h2>Deployment</h2>

        <h3>cPanel Git Deployment (Recommended)</h3>
        <ol>
            <li>Login to <strong>cPanel</strong> then <strong>Git Version Control</strong></li>
            <li>Click <strong>Create</strong> and enter:
                <ul>
                    <li>Clone URL: <code>https://github.com/Isolaee/gr-hakuvahti.git</code></li>
                    <li>Repository Path: <code>public_html/wp-content/plugins/acf-analyzer</code></li>
                </ul>
            </li>
            <li>Click <strong>Manage</strong> then <strong>Pull or Deploy</strong> then <strong>Deploy HEAD Commit</strong></li>
            <li>Activate in WordPress Admin then Plugins</li>
        </ol>

        <h3>Manual Installation</h3>
        <ol>
            <li>Clone or download the repository</li>
            <li>Copy to <code>wp-content/plugins/acf-analyzer/</code></li>
            <li>Activate in WordPress Admin then Plugins</li>
        </ol>

        <h3>True-Cron Setup (Shared Hosting)</h3>
        <p>For servers without reliable WP-Cron:</p>
        <ol>
            <li>Find your secret key in the admin panel</li>
            <li>Set up an external cron job to ping:</li>
        </ol>
        <pre><code>GET https://yoursite.com/?acf_analyzer_cron=1&amp;secret=YOUR_SECRET_KEY</code></pre>

        <div class="info-box warning">
            <strong>Security Note</strong>
            The secret key is stored in <code>acf_analyzer_secret_key</code> option. Keep it confidential.
        </div>
    </section>

    <!-- Troubleshooting Section -->
    <section id="troubleshooting" class="card">
        <h2>Troubleshooting</h2>

        <h3>Common Issues</h3>
        <table>
            <thead>
                <tr><th>Issue</th><th>Solution</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td>"This plugin requires ACF"</td>
                    <td>Install and activate Advanced Custom Fields plugin first</td>
                </tr>
                <tr>
                    <td>No fields found in search</td>
                    <td>Ensure posts with ACF data exist; click "Refresh Fields" in admin</td>
                </tr>
                <tr>
                    <td>Search results disappeared</td>
                    <td>Results are cached for 1 hour; run new search or wait</td>
                </tr>
                <tr>
                    <td>Emails not sending</td>
                    <td>Check server mail configuration and spam folder</td>
                </tr>
                <tr>
                    <td>True-cron returns 403</td>
                    <td>Verify secret key matches and is not empty</td>
                </tr>
            </tbody>
        </table>

        <h3>Debug Mode</h3>
        <p>View debug logs from the daily runner:</p>
        <ol>
            <li>Go to <strong>Tools</strong> then <strong>ACF Analyzer</strong></li>
            <li>Scroll to "Debug Log from Last Run" section</li>
            <li>View line-by-line execution trace</li>
        </ol>

        <h3>PHP Constants</h3>
        <pre><code>define('ACF_ANALYZER_VERSION', '1.0.0');
define('ACF_ANALYZER_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('ACF_ANALYZER_PLUGIN_URL', plugin_dir_url(__FILE__));</code></pre>
    </section>

    <!-- Footer -->
    <footer style="text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.9rem;">
        <p>ACF Field Analyzer (Hakuvahti) - Technical Documentation</p>
        <p>Version 1.0.0 | Generated January 2026</p>
    </footer>

</div>

</body>
</html>

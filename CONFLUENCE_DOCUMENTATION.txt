# ACF Field Analyzer (Hakuvahti) - Confluence Documentation
# Copy the content below into Confluence using the editor
# Use "Insert > Markup" or paste directly - Confluence will parse the formatting

================================================================================
CONFLUENCE PAGE: ACF Field Analyzer (Hakuvahti) - Technical Documentation
================================================================================

h1. ACF Field Analyzer (Hakuvahti)

{info:title=Plugin Overview}
A WordPress plugin for searching posts by Advanced Custom Fields (ACF) criteria and creating saved search "watches" (hakuvahdits) that automatically notify users when new matching posts are published.
{info}

||Property||Value||
|Version|1.0.0|
|Text Domain|acf-analyzer|
|Primary Language|Finnish with English fallbacks|
|Repository|https://github.com/Isolaee/gr-hakuvahti.git|

----

h2. Table of Contents

{toc:printable=true|style=square|maxLevel=3|minLevel=2}

----

h2. Features

h3. Core Search Capabilities

* *ACF Field Search* - Search posts by multiple ACF field criteria with AND/OR logic
* *Range Comparisons* - Support for numeric min/max field searches (e.g., price range)
* *Nested Field Support* - Access nested ACF fields using dot notation ({{parent.child}})
* *Value Normalization* - Handles special characters (Finnish/Swedish diacritics) for accurate matching

h3. Saved Searches (Hakuvahdits)

* *Save Search Criteria* - Users can save search configurations for repeated monitoring
* *New Post Detection* - Automatically tracks which posts have been seen vs. new
* *Email Notifications* - Sends formatted HTML emails when new posts match saved searches
* *Daily Runner* - Scheduled WP-Cron executes all saved searches and sends consolidated emails

h3. Integrations

||Integration||Description||Required||
|WP Grid Builder|Map WPGB facets to ACF fields for seamless filtering|Optional|
|WooCommerce|User management interface in My Account page|Optional|
|True-Cron|External HTTP ping endpoint for shared hosting|Optional|

h3. Admin Tools

* *Mapping Editor* - Configure WPGB facet-to-ACF field mappings
* *Debug Logs* - View execution logs from the daily runner
* *Recent Matches* - Monitor recent search matches
* *Field Discovery* - Automatic ACF field name detection

----

h2. Requirements

||Requirement||Version||Status||
|WordPress|5.8+|Required|
|PHP|7.4+|Required|
|Advanced Custom Fields (ACF)|Latest|Required|
|WooCommerce|Latest|Optional|
|WP Grid Builder|Latest|Optional|

{warning:title=Important}
The plugin will not function without ACF installed and activated. An admin notice will be displayed if ACF is missing.
{warning}

----

h2. Installation

h3. Via cPanel Git Deployment (Recommended)

{panel:title=Step-by-Step Installation|borderStyle=solid}
# Login to *cPanel* → *Git Version Control*
# Click *Create* and enter:
#* Clone URL: {{https://github.com/Isolaee/gr-hakuvahti.git}}
#* Repository Path: {{public_html/wp-content/plugins/acf-analyzer}}
#* Repository Name: {{acf-analyzer}}
# Click *Manage* → *Pull or Deploy* → *Deploy HEAD Commit*
# Activate in WordPress Admin → Plugins
{panel}

h3. Via ZIP Upload

# Download or clone the repository
# Create a ZIP file of the entire repository
# In WordPress admin, go to *Plugins* → *Add New*
# Click *Upload Plugin*
# Choose the ZIP file and click *Install Now*
# Click *Activate Plugin*

h3. Manual Installation

# Clone or download the repository
# Copy the entire folder to {{wp-content/plugins/acf-analyzer/}}
# Activate in WordPress Admin → Plugins

----

h2. Configuration

h3. WPGB Facet Mapping

Navigate to *Tools* → *ACF Analyzer* and use the mapping editor to connect WP Grid Builder facets to ACF fields:

{code:title=Example Mapping}
Facet Slug          ACF Field Name
─────────────────────────────────────
sijainti       →    sijainti_field
hinta          →    hinta_field
tyyppi         →    tyyppi_field
{code}

h3. Daily Runner Schedule

The plugin automatically schedules a daily WP-Cron event on activation. View status in the admin panel under "Scheduled Runner Status".

h3. True-Cron Setup (Optional)

{note:title=For Shared Hosting}
Use this if your hosting provider doesn't have reliable WP-Cron support.
{note}

# Find your secret key in the admin panel
# Set up an external cron job to ping:

{code}
GET https://yoursite.com/?acf_analyzer_cron=1&secret=YOUR_SECRET_KEY
{code}

----

h2. Usage

h3. Frontend: Saving a Hakuvahti

{panel:title=User Workflow|borderStyle=dashed}
# Visit a page with WP Grid Builder facets (e.g., Osakeannit, Osaketori, Velkakirjat)
# Use facets to filter results
# Click the "Tallenna hakuvahti" button
# Enter a name for your search and save
# Initial matching posts are marked as "seen"
{panel}

*Shortcode:*
{code:language=php}
[acf_hakuvahti category="osakeanti" button_text="Tallenna hakuvahti"]
{code}

h3. WooCommerce: Managing Hakuvahdits

# Go to My Account → Hakuvahdit
# View all saved searches with criteria summaries
# Run searches manually to check for new matches
# Edit names or delete searches

h3. Admin: Running Searches

# Navigate to *Tools* → *ACF Analyzer*
# Select category and add search criteria
# Choose match logic (AND/OR)
# Click "Run Search" to view results

h3. Email Notifications

When the daily runner finds new matches:
* Users receive one consolidated email per day
* Email contains all new matches grouped by hakuvahti
* HTML-formatted with post titles, excerpts, and links

----

h2. Architecture

h3. File Structure

{code:title=Plugin Directory Structure}
hakuvahti/
├── acf-analyzer.php                    # Main plugin bootstrap
├── includes/
│   ├── class-acf-analyzer.php          # Core search engine
│   ├── class-acf-analyzer-admin.php    # Admin interface & AJAX
│   ├── class-acf-analyzer-shortcode.php # Frontend shortcodes & AJAX
│   ├── class-hakuvahti.php             # Saved searches model
│   └── class-hakuvahti-woocommerce.php # WooCommerce integration
├── templates/
│   ├── admin-page.php                  # Admin dashboard
│   ├── hakuvahti-page.php              # WooCommerce account page
│   └── logger-button.php               # Shortcode button output
├── assets/
│   ├── css/
│   │   ├── admin.css                   # Admin styling
│   │   └── hakuvahti.css               # Frontend modal & page styling
│   └── js/
│       ├── admin-mapping.js            # Admin facet mapping editor
│       ├── wpgb-facet-logger.js        # Frontend facet collection
│       └── hakuvahti-page.js           # My Account page functionality
├── uninstall.php                       # Cleanup on uninstall
├── CPANEL_DEPLOYMENT.md                # Deployment guide
└── README.md                           # Documentation
{code}

h3. Core Classes

||Class||Responsibility||
|{{ACF_Analyzer}}|Core search engine with batch processing and field matching|
|{{ACF_Analyzer_Admin}}|Admin interface, AJAX handlers, mapping editor|
|{{ACF_Analyzer_Shortcode}}|Frontend shortcodes and public AJAX endpoints|
|{{Hakuvahti}}|Saved searches CRUD, daily runner, email notifications|
|{{Hakuvahti_WooCommerce}}|WooCommerce My Account endpoint integration|

h3. Search Algorithm

{panel:title=How Search Works|borderStyle=solid}
# Query posts in batches of 200 (memory management)
# Retrieve ACF fields via {{get_fields()}} for each post
# For each criterion, compare normalized values:
#* *Range*: {{field_min}}/{{field_max}} with >= / <= operators
#* *Array OR*: Match if any value equals actual
#* *Scalar*: Exact normalized match
# Apply match logic (AND requires all criteria, OR requires at least one)
# Return matched posts with metadata
{panel}

h3. Deduplication Strategy

* SHA1 hash: {{sha1($post_id . '|' . $hakuvahti_id)}}
* MySQL UNIQUE constraint on {{(search_id, match_hash)}}
* Prevents duplicate notifications for same post/search combination

----

h2. Database Schema

h3. Table: wp_hakuvahdit

Stores saved search configurations.

{code:language=sql|title=Schema}
CREATE TABLE wp_hakuvahdit (
    id BIGINT(20) UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT(20) UNSIGNED NOT NULL,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(100) NOT NULL,
    criteria LONGTEXT NOT NULL,         -- JSON-encoded search criteria
    seen_post_ids LONGTEXT,             -- JSON-encoded array of seen post IDs
    created_at DATETIME NOT NULL,
    updated_at DATETIME,
    KEY user_id (user_id)
);
{code}

h3. Table: wp_hakuvahti_matches

Stores deduplicated match results from daily runs.

{code:language=sql|title=Schema}
CREATE TABLE wp_hakuvahti_matches (
    id BIGINT(20) UNSIGNED PRIMARY KEY AUTO_INCREMENT,
    search_id BIGINT(20) UNSIGNED NOT NULL,
    match_id BIGINT(20) UNSIGNED NOT NULL,
    match_hash VARCHAR(64) NOT NULL,
    meta LONGTEXT,                       -- JSON post data
    created_at DATETIME NOT NULL,
    UNIQUE KEY search_match (search_id, match_hash),
    KEY search_id (search_id),
    KEY match_id (match_id)
);
{code}

h3. WordPress Options

||Option Key||Description||
|{{acf_wpgb_facet_map}}|WPGB facet → ACF field mappings|
|{{acf_analyzer_last_run}}|Timestamp of last daily runner execution|
|{{acf_analyzer_last_run_debug}}|Debug log from last run|
|{{acf_analyzer_secret_key}}|32-char secret for true-cron|
|{{acf_analyzer_ignore_seen}}|Flag for showing all vs. new posts only|

h3. Transients

||Transient Key||TTL||Description||
|{{acf_analyzer_field_names}}|1 hour|Cached ACF field list|
|{{acf_analyzer_search_results}}|1 hour|Cached search results|

----

h2. API Reference

h3. AJAX Endpoints

h4. Public Endpoints (no login required)

||Action||Description||Parameters||
|{{acf_popup_search}}|Search posts by criteria|nonce, category, criteria, match_logic|
|{{acf_popup_get_fields}}|Get ACF fields for category|nonce, category|

h4. Authenticated Endpoints (login required)

||Action||Description||Parameters||
|{{hakuvahti_save}}|Create/update saved search|nonce, name, category, criteria|
|{{hakuvahti_list}}|List user's saved searches|nonce|
|{{hakuvahti_run}}|Execute saved search|nonce, id|
|{{hakuvahti_delete}}|Delete saved search|nonce, id|

h4. Admin Endpoints (manage_options required)

||Action||Description||Parameters||
|{{acf_analyzer_save_mapping}}|Save WPGB facet mappings|nonce, mapping|
|{{acf_analyzer_get_fields}}|Refresh field names cache|nonce|

h3. PHP Hooks

*Actions:*
{code:language=php}
// Scheduled daily runner
do_action('acf_analyzer_daily_runner');
{code}

h3. JavaScript API

*Facet Logger (wpgb-facet-logger.js):*
{code:language=javascript}
// Collect current facet values
const criteria = getCurrentCriteria(targetGrid, useApi);

// Format criteria for display
const html = formatCriteriaPreview(criteria);

// Get WPGB instances
const instances = getWpgbInstances();
{code}

----

h2. Security

h3. Nonce Verification

||Nonce Action||Usage||
|{{acf_analyzer_save_mapping}}|Admin mapping saves|
|{{acf_analyzer_search}}|Admin search form|
|{{acf_popup_search}}|Frontend search|
|{{hakuvahti_nonce}}|Hakuvahti CRUD operations|

h3. Access Control

* *Admin functions*: {{current_user_can('manage_options')}} check
* *User operations*: Ownership verification ({{user_id}} match)
* *True-cron*: {{hash_equals()}} constant-time comparison

h3. Data Sanitization

||Input Type||Method||
|POST input|{{sanitize_text_field()}}|
|JSON data|{{wp_json_encode()}} / {{json_decode()}} with validation|
|SQL queries|{{$wpdb->prepare()}} with placeholders|
|Output|{{esc_html()}}, {{esc_attr()}}, {{esc_url()}}|

----

h2. Troubleshooting

h3. Common Issues

{expand:title="This plugin requires ACF" error}
*Solution:* Install and activate the Advanced Custom Fields plugin first.
{expand}

{expand:title=No fields found in search}
*Solutions:*
* Ensure posts with ACF data exist in the selected categories
* Click "Refresh Fields" in admin to clear the cache
{expand}

{expand:title=Search results disappeared}
*Solution:* Results are cached for 1 hour via transients. Run a new search or wait for cache expiration.
{expand}

{expand:title=Emails not sending}
*Solutions:*
* Check server mail configuration
* Verify WordPress email settings
* Check spam folder
{expand}

{expand:title=Facet logger shows no data}
*Solutions:*
* Ensure WP Grid Builder is active
* Verify facets have selected values
* Check browser console for JavaScript errors
{expand}

{expand:title=True-cron returns 403}
*Solutions:*
* Verify the secret key matches
* Ensure the key is not empty
{expand}

h3. Debug Mode

Enable debug logging by adding criteria with {{debug: true}}:

{code:language=php}
$criteria = [
    'field_name' => 'value',
    'debug' => true
];
{code}

Debug output is written to PHP error log and stored in {{acf_analyzer_last_run_debug}} option.

h3. Viewing Debug Logs

# Go to *Tools* → *ACF Analyzer*
# Scroll to "Debug Log from Last Run" section
# View line-by-line execution trace

----

h2. Development

h3. Constants

{code:language=php}
define('ACF_ANALYZER_VERSION', '1.0.0');
define('ACF_ANALYZER_PLUGIN_DIR', plugin_dir_path(__FILE__));
define('ACF_ANALYZER_PLUGIN_URL', plugin_dir_url(__FILE__));
{code}

h3. Adding New Search Criteria Types

Extend the {{search_by_criteria()}} method in {{class-acf-analyzer.php}}:

{code:language=php}
// In the comparison loop, add new comparison type
if ($your_condition) {
    // Custom matching logic
    $match = your_comparison($actual_value, $criteria_value);
}
{code}

h3. Customizing Email Templates

Modify {{build_email_html()}} in {{class-hakuvahti.php}}:

{code:language=php}
public function build_email_html($user, $grouped) {
    // Custom HTML template
}
{code}

h3. Supported Categories

Default categories (configurable in class constructors):

||Category Slug||Description||
|{{osakeanti}}|Share offerings|
|{{osaketori}}|Stock market|
|{{velkakirja}}|Debt instruments|

h3. Testing Workflow

{panel:title=Manual Testing Steps|borderStyle=dashed}
# Create test posts with ACF data
# Set up WPGB facets pointing to ACF fields
# Configure facet mappings in admin
# Save a hakuvahti from the frontend
# Manually trigger the daily runner
# Verify email delivery and match recording
{panel}

----

h2. Deployment & Updates

h3. Updating via cPanel

# Push changes to the GitHub repository
# In cPanel → Git Version Control
# Click *Manage* on the repository
# Click *Pull or Deploy* → *Deploy HEAD Commit*

h3. Backup Considerations

||Item||Location||
|Database tables|{{wp_hakuvahdit}}, {{wp_hakuvahti_matches}}|
|Options|All {{acf_analyzer_*}} in {{wp_options}}|
|Mappings|{{acf_wpgb_facet_map}} option|

{tip:title=No file-based user data}
All user data is stored in the database. No file backups needed beyond the plugin code.
{tip}

----

h2. Support

{info}
For issues and feature requests, contact the development team or create an issue in the repository.
{info}

||Contact||Details||
|Repository|[https://github.com/Isolaee/gr-hakuvahti]|
|Documentation|This page|

----

{panel:title=Document Information|borderStyle=solid|borderColor=#ccc}
*Last Updated:* {date}
*Version:* 1.0.0
*Author:* GR Development Team
{panel}
